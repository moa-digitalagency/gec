# Journal des Modifications (CHANGELOG)

## [Migration Replit Agent] - 2025-10-15

### ‚úÖ Migration Compl√©t√©e

#### Infrastructure
- ‚úÖ Installation de l'environnement Python 3.11
- ‚úÖ Installation de toutes les d√©pendances du projet via pyproject.toml
  - Flask 3.1.1 et extensions (flask-login, flask-sqlalchemy)
  - PostgreSQL (psycopg2-binary)
  - Cryptographie (cryptography, pycryptodome, bcrypt)
  - G√©n√©ration de documents (reportlab, xlsxwriter, pandas)
  - Traitement d'images (opencv-python, pillow)
  - Communication (sendgrid, requests)
  - Serveur web (gunicorn)

#### D√©ploiement
- ‚úÖ Configuration du workflow "Start application" avec gunicorn
  - Commande: `gunicorn --bind 0.0.0.0:5000 --reuse-port --reload main:app`
  - Port: 5000 (seul port non-firewal√©)
  - Auto-reload activ√© pour le d√©veloppement
- ‚úÖ Configuration du d√©ploiement en production (autoscale)
  - Type: autoscale (adapt√© aux sites web stateless)
  - Build: Non requis (Python interpr√©t√©)
  - Run: `gunicorn --bind 0.0.0.0:5000 main:app`

#### Application
- ‚úÖ V√©rification du bon fonctionnement de l'application
  - Interface de connexion op√©rationnelle
  - Base de donn√©es PostgreSQL initialis√©e
  - Utilisateur admin par d√©faut cr√©√© (username: sa.gec001)
  - Tables et sch√©ma de base de donn√©es cr√©√©s
  - Migrations automatiques appliqu√©es

### üÜï Nouvelles Fonctionnalit√©s

#### Module d'Export/Import de Courriers (export_import_utils.py)
**Probl√®me r√©solu**: Les sauvegardes/restaurations √©chouaient lors du transfert entre instances GEC diff√©rentes car les donn√©es chiffr√©es avec la cl√© `GEC_MASTER_KEY` d'une instance ne pouvaient pas √™tre d√©chiffr√©es avec la cl√© d'une autre instance.

**Solution impl√©ment√©e**:

1. **Fonction `export_courriers_to_json()`**
   - Exporte les courriers en format JSON
   - **D√©chiffre automatiquement** toutes les donn√©es sensibles avant export:
     - Objet du courrier (objet_encrypted ‚Üí objet en clair)
     - Exp√©diteur (expediteur_encrypted ‚Üí expediteur en clair)
     - Destinataire (destinataire_encrypted ‚Üí destinataire en clair)
     - Num√©ro de r√©f√©rence (numero_reference_encrypted ‚Üí numero_reference en clair)
   - G√®re les pi√®ces jointes avec leur statut de chiffrement
   - Inclut les m√©tadonn√©es de version pour compatibilit√©

2. **Fonction `create_export_package()`**
   - Cr√©e un package ZIP complet avec:
     - Fichier JSON contenant les donn√©es d√©chiffr√©es
     - Fichiers attach√©s **d√©chiffr√©s** (extraits du chiffrement avec la cl√© source)
     - Pi√®ces jointes des transmissions
     - M√©tadonn√©es d'export (version, date, nombre de courriers)
   - Format: `export_courriers_YYYYMMDD_HHMMSS.zip`
   - Stockage dans le dossier `exports/`

3. **Fonction `import_courriers_from_package()`**
   - Importe les courriers depuis un package ZIP
   - **Re-chiffre automatiquement** avec la cl√© de l'instance de destination:
     - Objet en clair ‚Üí objet_encrypted avec nouvelle cl√©
     - Exp√©diteur en clair ‚Üí expediteur_encrypted avec nouvelle cl√©
     - Destinataire en clair ‚Üí destinataire_encrypted avec nouvelle cl√©
     - Num√©ro de r√©f√©rence en clair ‚Üí numero_reference_encrypted avec nouvelle cl√©
   - Re-chiffre les fichiers attach√©s avec la nouvelle cl√©
   - Options:
     - `skip_existing`: Ignore les courriers d√©j√† pr√©sents (par num√©ro)
     - `remap_users`: Remapper les utilisateurs entre instances
   - Gestion des erreurs et statistiques d'import d√©taill√©es

**Format d'Export (v1.0.0)**:
```json
{
  "version": "1.0.0",
  "export_date": "2025-10-15T...",
  "total_courriers": 100,
  "courriers": [
    {
      "id": 1,
      "numero_accuse_reception": "GEC-2025-001",
      "objet": "Objet d√©chiffr√© en clair",
      "expediteur": "Exp√©diteur d√©chiffr√© en clair",
      "destinataire": "Destinataire d√©chiffr√© en clair",
      "numero_reference": "R√©f√©rence d√©chiffr√©e en clair",
      "forwards": [...],
      ...
    }
  ],
  "attachments": [
    {
      "courrier_id": 1,
      "type": "main",
      "filename": "document.pdf",
      "path": "uploads/...",
      "encrypted": true,
      "checksum": "sha256..."
    }
  ]
}
```

#### Routes Flask Ajout√©es (views.py)

1. **Route `/export_courriers` (POST)**
   - R√©serv√©e aux super administrateurs
   - Param√®tres:
     - `export_all`: Exporter tous les courriers (incluant supprim√©s)
     - `courrier_ids`: Liste d'IDs sp√©cifiques √† exporter
   - T√©l√©charge automatiquement le fichier ZIP d'export
   - Log de l'activit√© dans le journal d'audit

2. **Route `/import_courriers` (POST)**
   - R√©serv√©e aux super administrateurs
   - Upload d'un fichier ZIP d'export
   - Param√®tres:
     - `skip_existing`: Ignorer les doublons (par d√©faut: true)
   - Affiche les statistiques d√©taill√©es:
     - Nombre de courriers import√©s
     - Nombre de courriers ignor√©s (doublons)
     - Nombre d'erreurs rencontr√©es
   - Log de l'activit√© avec d√©tails

#### S√©curit√© et Chiffrement

**Gestion des Cl√©s de Chiffrement**:
- Chaque instance GEC poss√®de sa propre cl√© `GEC_MASTER_KEY` (256-bit AES)
- Les donn√©es sensibles sont chiffr√©es avec AES-256-CBC
- Le processus export/import assure la compatibilit√© entre instances:
  1. **Export**: D√©chiffrement avec cl√© source ‚Üí stockage en clair (s√©curis√© dans ZIP)
  2. **Import**: Re-chiffrement avec cl√© destination ‚Üí stockage s√©curis√©

**Avantages**:
- ‚úÖ Transfert s√©curis√© de courriers entre instances GEC
- ‚úÖ Pas de perte de donn√©es lors des migrations
- ‚úÖ Compatibilit√© garantie entre versions identiques
- ‚úÖ Tra√ßabilit√© compl√®te via logs d'audit

### üîß Am√©liorations Syst√®me

#### Gestion des Sauvegardes
- Le syst√®me de backup existant (`create_system_backup`, `restore_system_from_backup`) reste inchang√©
- Nouveau syst√®me export/import d√©di√© au transfert de courriers entre instances
- S√©paration claire:
  - **Backups syst√®me**: Sauvegarde compl√®te de l'instance (avec cl√©s chiffr√©es)
  - **Export/Import**: Transfert de courriers entre instances (avec re-chiffrement)

#### Logs et Tra√ßabilit√©
- Nouveaux types d'activit√©s dans le journal:
  - `EXPORT_COURRIERS`: Export de courriers effectu√©
  - `IMPORT_COURRIERS`: Import de courriers avec statistiques

### ‚ö†Ô∏è Points d'Attention

#### Variables d'Environnement Critiques
Les cl√©s suivantes doivent √™tre configur√©es pour la persistence et la s√©curit√©:

1. **GEC_MASTER_KEY** (CRITIQUE)
   - Cl√© de chiffrement principale (256-bit)
   - G√©n√©r√©e automatiquement si absente (voir logs CRITICAL)
   - ‚ö†Ô∏è DOIT √™tre sauvegard√©e et configur√©e en production
   - Utilis√©e pour chiffrer toutes les donn√©es sensibles

2. **GEC_PASSWORD_SALT** (CRITIQUE)
   - Sel pour le hachage des mots de passe
   - G√©n√©r√© automatiquement si absent (voir logs CRITICAL)
   - ‚ö†Ô∏è DOIT √™tre sauvegard√© et configur√© en production

3. **SESSION_SECRET**
   - Secret pour les sessions Flask
   - Configur√© par d√©faut: "dev-secret-key-gec-mines"
   - ‚ö†Ô∏è Doit √™tre chang√© en production

4. **DATABASE_URL**
   - URL de connexion PostgreSQL
   - Par d√©faut: SQLite (gec_mines.db)
   - ‚ö†Ô∏è Utiliser PostgreSQL en production

5. **ADMIN_PASSWORD**
   - Mot de passe de l'utilisateur admin initial (sa.gec001)
   - Par d√©faut: "TempPassword123!"
   - ‚ö†Ô∏è Doit √™tre chang√© imm√©diatement apr√®s premi√®re connexion

#### Configuration Sendgrid
- Int√©gration Sendgrid configur√©e mais n√©cessite setup
- Voir `use_integration` pour configurer les cl√©s API

### üìã √Ä Faire (TODO)

#### Configuration Initiale Requise
1. ‚ö†Ô∏è **URGENT**: Configurer les cl√©s de chiffrement en production
   ```bash
   # G√©n√©rer les cl√©s (utiliser generate_keys.py si disponible)
   # Puis configurer dans Secrets Replit:
   GEC_MASTER_KEY=<cl√©_base64>
   GEC_PASSWORD_SALT=<sel_base64>
   SESSION_SECRET=<secret_aleatoire>
   ```

2. ‚ö†Ô∏è Changer le mot de passe admin par d√©faut
   - Utilisateur: sa.gec001
   - Mot de passe par d√©faut: TempPassword123!

3. Configurer Sendgrid pour les notifications email
   - Utiliser l'int√©gration Replit Sendgrid
   - Configurer les templates d'email

#### Optimisations Futures
- [ ] Ajouter compression des exports pour fichiers volumineux
- [ ] Impl√©menter import/export incr√©mental (par date)
- [ ] Ajouter validation de sch√©ma avant import
- [ ] Interface utilisateur pour s√©lection de courriers √† exporter
- [ ] Support multi-version pour compatibilit√© ascendante/descendante
- [ ] Export/import des utilisateurs et d√©partements associ√©s
- [ ] Chiffrement du fichier ZIP d'export pour transit s√©curis√©

### üêõ Corrections de Bugs

#### Probl√®me de Restauration entre Instances
- **Probl√®me**: Les sauvegardes restaur√©es sur une autre instance ne fonctionnaient pas car les donn√©es chiffr√©es ne pouvaient pas √™tre d√©chiffr√©es
- **Cause**: Cl√©s de chiffrement `GEC_MASTER_KEY` diff√©rentes entre instances
- **Solution**: Nouveau syst√®me export/import avec d√©chiffrement/rechiffrement automatique

#### Bug Critique Corrig√©: Double Chiffrement des Fichiers (v1.0.1)
- **Probl√®me Identifi√©**: Lors de l'export, si un fichier ne pouvait pas √™tre d√©chiffr√©, il √©tait ajout√© tel quel (chiffr√©) au package ZIP
- **Cons√©quence**: √Ä l'import, ces fichiers d√©j√† chiffr√©s √©taient re-chiffr√©s avec la nouvelle cl√©, cr√©ant un double chiffrement et rendant les fichiers inutilisables
- **Solution Impl√©ment√©e**:
  1. L'export √©choue maintenant compl√®tement si un fichier ne peut pas √™tre d√©chiffr√©
  2. Le fichier ZIP incomplet est automatiquement supprim√©
  3. Un message d'erreur d√©taill√© liste tous les fichiers probl√©matiques
  4. Aucun fichier chiffr√© ne peut √™tre ajout√© √† l'export par erreur
- **Validation**: L'import v√©rifie maintenant la pr√©sence des fichiers et √©met des avertissements clairs si des fichiers sont manquants

### üìä Statistiques du Projet

#### Fichiers Modifi√©s
- ‚úÖ `export_import_utils.py` - CR√â√â (nouveau module)
- ‚úÖ `views.py` - MODIFI√â (2 nouvelles routes)
- ‚úÖ `CHANGELOG.md` - CR√â√â (ce fichier)
- ‚úÖ `.local/state/replit/agent/progress_tracker.md` - MIS √Ä JOUR

#### Fonctionnalit√©s Ajout√©es
- Export de courriers avec d√©chiffrement
- Import de courriers avec rechiffrement
- Package ZIP portable entre instances
- Gestion des pi√®ces jointes chiffr√©es
- Logs et tra√ßabilit√© d'export/import

### üìñ Documentation

#### Guide d'Utilisation - Export

1. Se connecter en tant que super administrateur
2. Aller dans "Gestion des sauvegardes"
3. Section "Export de Courriers"
4. Options:
   - Exporter tous les courriers
   - OU sp√©cifier des IDs de courriers (s√©par√©s par virgules)
5. Cliquer sur "Exporter"
6. Le fichier ZIP sera t√©l√©charg√© automatiquement

#### Guide d'Utilisation - Import

1. Se connecter en tant que super administrateur sur l'instance cible
2. Aller dans "Gestion des sauvegardes"
3. Section "Import de Courriers"
4. S√©lectionner le fichier ZIP d'export
5. Options:
   - Ignorer les doublons (recommand√©)
6. Cliquer sur "Importer"
7. Consulter les statistiques d'import affich√©es

#### S√©curit√© du Processus

**Export**:
1. Les donn√©es sont extraites de la base de donn√©es
2. Les champs chiffr√©s sont d√©chiffr√©s avec `GEC_MASTER_KEY` source
3. Les fichiers attach√©s chiffr√©s sont d√©chiffr√©s
4. Tout est empaquet√© dans un ZIP (donn√©es en clair, s√©curis√©)
5. ‚ö†Ô∏è Le fichier ZIP doit √™tre transf√©r√© de mani√®re s√©curis√©e (HTTPS, SSH, etc.)

**Import**:
1. Le ZIP est extrait dans un dossier temporaire
2. Les donn√©es JSON sont lues
3. Pour chaque courrier:
   - Les donn√©es en clair sont lues
   - Les donn√©es sont re-chiffr√©es avec `GEC_MASTER_KEY` destination
   - Les fichiers sont re-chiffr√©s avec la nouvelle cl√©
   - Les donn√©es sont ins√©r√©es dans la base
4. Le dossier temporaire est nettoy√©

### ‚úÖ Tests Effectu√©s

- ‚úÖ Application d√©marre correctement avec gunicorn
- ‚úÖ Base de donn√©es PostgreSQL initialis√©e
- ‚úÖ Interface web accessible sur port 5000
- ‚úÖ Page de connexion fonctionnelle
- ‚úÖ Utilisateur admin cr√©√© automatiquement
- ‚úÖ Migrations automatiques appliqu√©es
- ‚úÖ Syst√®me de chiffrement op√©rationnel (avec warnings de configuration)

### üîç Tests √† Effectuer

- [ ] Test d'export de courriers r√©els
- [ ] Test d'import sur instance avec cl√© diff√©rente
- [ ] V√©rification de l'int√©grit√© des donn√©es apr√®s import
- [ ] Test des pi√®ces jointes chiffr√©es
- [ ] Test des courriers avec transmissions
- [ ] Test de performance avec grand volume de donn√©es
- [ ] Test de gestion des erreurs et rollback

---

## Notes Techniques

### Architecture du Syst√®me d'Export/Import

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Instance A     ‚îÇ         ‚îÇ  Package ZIP     ‚îÇ         ‚îÇ  Instance B     ‚îÇ
‚îÇ  (GEC_KEY_A)    ‚îÇ         ‚îÇ  (donn√©es claires)‚îÇ         ‚îÇ  (GEC_KEY_B)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ         ‚îÇ                 ‚îÇ
‚îÇ Donn√©es crypt√©es‚îÇ‚îÄExport‚îÄ‚Üí‚îÇ Donn√©es en clair ‚îÇ‚îÄImport‚îÄ‚Üí‚îÇ Donn√©es crypt√©es‚îÇ
‚îÇ avec KEY_A      ‚îÇ         ‚îÇ + fichiers       ‚îÇ         ‚îÇ avec KEY_B      ‚îÇ
‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ         ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                            ‚îÇ                            ‚îÇ
       ‚ñº                            ‚ñº                            ‚ñº
  D√©chiffrement              Format portable               Re-chiffrement
   avec KEY_A                  (JSON + ZIP)                 avec KEY_B
```

### Format de Versioning

- Format d'export: v1.0.0
- Compatibilit√©: M√™me version majeure (1.x.x)
- Migration automatique du sch√©ma via migration_utils.py

### D√©pendances Critiques

- **encryption_utils.py**: Gestion du chiffrement/d√©chiffrement
- **models.py**: Mod√®les Courrier, PieceJointe, CourrierForward
- **utils.py**: Fonctions utilitaires et backup syst√®me
- **migration_utils.py**: Migrations automatiques de sch√©ma

---

*Derni√®re mise √† jour: 2025-10-15*
*Cr√©√© pendant la migration Replit Agent*
