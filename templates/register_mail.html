{% extends "new_base.html" %}

{% block title %}Enregistrer Courrier - GEC Mines{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-plus-circle mr-3 text-rdc-blue"></i>
        Enregistrer un Nouveau Courrier
    </h1>
    <p class="mt-2 text-gray-600">Saisissez les informations du courrier (entrant ou sortant)</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Form -->
    <div class="lg:col-span-2">
        <div class="bg-white shadow-rdc rounded-xl">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-edit mr-2 text-rdc-blue"></i>
                    Informations du Courrier
                </h2>
            </div>
            <div class="p-6">
                <form method="POST" enctype="multipart/form-data" class="space-y-6">
                    <!-- Type de Courrier -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-exchange-alt mr-1 text-rdc-blue"></i>
                            Type de Courrier <span class="text-red-500">*</span>
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative flex items-center p-3 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-rdc-blue mail-type-option">
                                <input type="radio" 
                                       name="type_courrier" 
                                       value="ENTRANT" 
                                       checked
                                       class="sr-only"
                                       onchange="toggleContactField()">
                                <div class="radio-visual w-4 h-4 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                    <div class="w-2 h-2 rounded-full bg-rdc-blue hidden"></div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-inbox mr-2 text-blue-500"></i>
                                    <span class="text-sm font-medium">Entrant</span>
                                </div>
                            </label>
                            
                            <label class="relative flex items-center p-3 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-rdc-blue mail-type-option">
                                <input type="radio" 
                                       name="type_courrier" 
                                       value="SORTANT"
                                       class="sr-only"
                                       onchange="toggleContactField()">
                                <div class="radio-visual w-4 h-4 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                    <div class="w-2 h-2 rounded-full bg-rdc-blue hidden"></div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-paper-plane mr-2 text-green-500"></i>
                                    <span class="text-sm font-medium">Sortant</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Reference and Contact -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="numero_reference" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-hashtag mr-1 text-rdc-blue"></i>
                                Numéro de Référence
                            </label>
                            <input type="text" 
                                   id="numero_reference" 
                                   name="numero_reference" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-rdc-blue focus:border-rdc-blue"
                                   placeholder="Optionnel - Si non renseigné: Non référencé">
                            <p class="mt-1 text-xs text-gray-500">Laissez vide si aucun numéro de référence</p>
                        </div>
                        
                        <div id="contact-field">
                            <label for="contact" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-1 text-rdc-blue"></i>
                                <span id="contact-label">Expéditeur</span> <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   id="contact" 
                                   name="expediteur" 
                                   required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-rdc-blue focus:border-rdc-blue"
                                   placeholder="Nom de l'expéditeur">
                            <!-- Hidden field for destinataire -->
                            <input type="hidden" 
                                   id="destinataire" 
                                   name="destinataire" 
                                   value="">
                        </div>
                    </div>
                    
                    <!-- Object -->
                    <div>
                        <label for="objet" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-file-alt mr-1 text-rdc-blue"></i>
                            Objet de la Lettre <span class="text-red-500">*</span>
                        </label>
                        <textarea id="objet" 
                                  name="objet" 
                                  rows="4" 
                                  required 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-rdc-blue focus:border-rdc-blue"
                                  placeholder="Décrivez l'objet de la lettre"></textarea>
                    </div>
                    
                    <!-- Date de rédaction -->
                    <div>
                        <label for="date_redaction" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-edit mr-1 text-rdc-blue"></i>
                            Date de Rédaction de la Lettre
                        </label>
                        <input type="date" 
                               id="date_redaction" 
                               name="date_redaction" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-rdc-blue focus:border-rdc-blue">
                        <p class="mt-1 text-sm text-gray-500">
                            Date à laquelle la lettre a été rédigée (optionnel)
                        </p>
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label for="statut" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-flag mr-1 text-rdc-blue"></i>
                            Statut Initial <span class="text-red-500">*</span>
                        </label>
                        <select id="statut" 
                                name="statut" 
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-rdc-blue focus:border-rdc-blue">
                            {% if statuts_disponibles %}
                                {% for statut_obj in statuts_disponibles %}
                                    <option value="{{ statut_obj.nom }}" {% if statut_obj.nom == 'RECU' %}selected{% endif %}>
                                        {{ statut_obj.nom.replace('_', ' ').title() }}
                                        {% if statut_obj.description %}
                                            - {{ statut_obj.description }}
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="RECU" selected>Reçu</option>
                                <option value="EN_COURS">En cours</option>
                                <option value="TRAITE">Traité</option>
                                <option value="URGENT">Urgent</option>
                                <option value="ARCHIVE">Archivé</option>
                            {% endif %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            Choisissez le statut initial pour ce courrier
                        </p>
                    </div>
                    
                    <!-- File Upload Avancé -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-paperclip mr-1 text-rdc-blue"></i>
                            Pièce Jointe
                        </label>
                        
                        <!-- Options de téléchargement -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Upload Fichier -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-rdc-blue transition-colors cursor-pointer" id="file-upload-zone">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                                <p class="text-sm font-medium text-gray-700">Télécharger fichier</p>
                                <p class="text-xs text-gray-500">PDF, JPG, PNG</p>
                                <input id="fichier" 
                                       name="fichier" 
                                       type="file" 
                                       class="hidden" 
                                       accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif">
                            </div>
                            
                            <!-- Capture Webcam -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-rdc-green transition-colors cursor-pointer" id="webcam-capture-btn">
                                <i class="fas fa-camera text-3xl text-gray-400 mb-3"></i>
                                <p class="text-sm font-medium text-gray-700">Capture webcam</p>
                                <p class="text-xs text-gray-500">Prendre une photo</p>
                            </div>
                        </div>
                        
                        <!-- Zone de prévisualisation -->
                        <div id="file-preview" class="mt-4 hidden">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-medium text-gray-900">Fichier sélectionné</h4>
                                    <div class="flex items-center space-x-2">
                                        <button type="button" id="crop-image-btn" class="px-3 py-1 text-xs bg-rdc-yellow text-white rounded-md hover:bg-opacity-90 hidden">
                                            <i class="fas fa-crop-alt mr-1"></i>Rogner
                                        </button>
                                        <button type="button" id="remove-file" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="preview-content" class="mb-3">
                                    <!-- Le contenu de prévisualisation sera inséré ici -->
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="file-info"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-6">
                        <button type="submit" 
                                class="flex-1 flex justify-center items-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-rdc-blue hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-rdc-blue transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            Enregistrer le Courrier
                        </button>
                        <a href="{{ url_for('dashboard') }}" 
                           class="flex justify-center items-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-rdc-blue transition-colors">
                            <i class="fas fa-times mr-2"></i>
                            Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Auto Info -->
        <div class="bg-white shadow-rdc rounded-xl">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-rdc-blue"></i>
                    Informations Automatiques
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <div class="flex items-center text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-calendar mr-2 text-rdc-green"></i>
                        Date d'enregistrement
                    </div>
                    <div class="text-sm text-gray-600 current-time"></div>
                </div>
                
                <div>
                    <div class="flex items-center text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-2 text-rdc-green"></i>
                        Enregistré par
                    </div>
                    <div class="text-sm text-gray-600">{{ current_user.nom_complet }}</div>
                </div>
                
                <div>
                    <div class="flex items-center text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-receipt mr-2 text-rdc-green"></i>
                        N° d'accusé
                    </div>
                    <div class="text-sm text-gray-600">Généré automatiquement</div>
                </div>
            </div>
        </div>
        
        <!-- Help -->
        <div class="bg-white shadow-rdc rounded-xl">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <i class="fas fa-question-circle mr-2 text-rdc-blue"></i>
                    Guide d'Utilisation
                </h3>
            </div>
            <div class="p-6">
                <ul class="space-y-3 text-sm text-gray-600">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-rdc-green mr-2 mt-0.5 flex-shrink-0"></i>
                        Les champs marqués d'un * sont obligatoires
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-rdc-green mr-2 mt-0.5 flex-shrink-0"></i>
                        Le numéro d'accusé sera généré automatiquement
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-rdc-green mr-2 mt-0.5 flex-shrink-0"></i>
                        Vous pouvez enregistrer sans pièce jointe
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-rdc-green mr-2 mt-0.5 flex-shrink-0"></i>
                        Taille maximum: 16MB par fichier
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal Webcam -->
<div id="webcam-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-camera mr-2 text-rdc-green"></i>
                        Capture Webcam
                    </h3>
                    <button type="button" id="close-webcam" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center">
                    <video id="webcam-video" autoplay class="w-full max-w-lg mx-auto rounded-lg mb-4" style="display: none;"></video>
                    <canvas id="webcam-canvas" class="w-full max-w-lg mx-auto rounded-lg mb-4" style="display: none;"></canvas>
                    <div id="webcam-placeholder" class="w-full max-w-lg mx-auto h-64 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                        <div class="text-center">
                            <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Cliquez sur "Démarrer caméra" pour commencer</p>
                        </div>
                    </div>
                    <div class="space-x-4">
                        <button type="button" id="start-camera" class="px-4 py-2 bg-rdc-blue text-white rounded-md hover:bg-opacity-90">
                            <i class="fas fa-play mr-2"></i>Démarrer caméra
                        </button>
                        <button type="button" id="capture-photo" class="px-4 py-2 bg-rdc-green text-white rounded-md hover:bg-opacity-90" style="display: none;">
                            <i class="fas fa-camera mr-2"></i>Capturer
                        </button>
                        <button type="button" id="retake-photo" class="px-4 py-2 bg-rdc-yellow text-white rounded-md hover:bg-opacity-90" style="display: none;">
                            <i class="fas fa-redo mr-2"></i>Reprendre
                        </button>
                        <button type="button" id="use-photo" class="px-4 py-2 bg-rdc-green text-white rounded-md hover:bg-opacity-90" style="display: none;">
                            <i class="fas fa-check mr-2"></i>Utiliser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Rognage -->
<div id="crop-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-crop-alt mr-2 text-rdc-yellow"></i>
                        Rogner l'image
                    </h3>
                    <button type="button" id="close-crop" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center">
                    <div id="crop-container" class="max-w-2xl mx-auto mb-4">
                        <img id="crop-image" class="max-w-full" style="display: none;">
                    </div>
                    <div class="space-x-4">
                        <button type="button" id="apply-crop" class="px-4 py-2 bg-rdc-green text-white rounded-md hover:bg-opacity-90">
                            <i class="fas fa-crop mr-2"></i>Appliquer
                        </button>
                        <button type="button" id="cancel-crop" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-opacity-90">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Cropperjs CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<!-- Cropperjs JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<script>
// Variables globales
let webcamStream = null;
let cropper = null;
let currentFile = null;

// Système de fichiers avancé
class AdvancedFileHandler {
    constructor() {
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        // Zone d'upload de fichier
        document.getElementById('file-upload-zone').addEventListener('click', () => {
            document.getElementById('fichier').click();
        });

        // Gestion du fichier sélectionné
        document.getElementById('fichier').addEventListener('change', (e) => {
            this.handleFileSelection(e);
        });

        // Bouton webcam
        document.getElementById('webcam-capture-btn').addEventListener('click', () => {
            this.openWebcamModal();
        });

        // Bouton rogner (dans la zone de prévisualisation)
        document.getElementById('crop-image-btn').addEventListener('click', () => {
            if (currentFile && currentFile.type.startsWith('image/')) {
                this.openCropModal();
            }
        });

        // Bouton supprimer
        document.getElementById('remove-file').addEventListener('click', () => {
            this.removeFile();
        });

        // Modals
        this.initializeWebcamModal();
        this.initializeCropModal();
    }

    handleFileSelection(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Vérification de taille
        if (file.size > 16 * 1024 * 1024) {
            alert('Erreur: Le fichier est trop volumineux (max 16MB)');
            e.target.value = '';
            return;
        }

        // Vérification du type
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/tiff'];
        if (!allowedTypes.includes(file.type)) {
            alert('Erreur: Type de fichier non autorisé');
            e.target.value = '';
            return;
        }

        currentFile = file;
        this.showFilePreview(file);
    }

    showFilePreview(file) {
        const preview = document.getElementById('file-preview');
        const previewContent = document.getElementById('preview-content');
        const fileInfo = document.getElementById('file-info');
        const cropBtn = document.getElementById('crop-image-btn');
        
        // Mise à jour des informations
        fileInfo.textContent = `${file.name} - ${this.formatFileSize(file.size)}`;
        
        // Prévisualisation selon le type
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewContent.innerHTML = `
                    <img src="${e.target.result}" alt="Prévisualisation" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                `;
            };
            reader.readAsDataURL(file);
            
            // Afficher le bouton de rognage pour les images
            cropBtn.classList.remove('hidden');
        } else if (file.type === 'application/pdf') {
            previewContent.innerHTML = `
                <div class="flex items-center justify-center h-32 bg-red-50 rounded-lg">
                    <i class="fas fa-file-pdf text-4xl text-red-500"></i>
                </div>
            `;
            
            // Masquer le bouton de rognage pour les PDF
            cropBtn.classList.add('hidden');
        }
        
        preview.classList.remove('hidden');
    }

    removeFile() {
        document.getElementById('fichier').value = '';
        document.getElementById('file-preview').classList.add('hidden');
        document.getElementById('crop-image-btn').classList.add('hidden');
        currentFile = null;
    }

    // Webcam Modal
    initializeWebcamModal() {
        const modal = document.getElementById('webcam-modal');
        const startBtn = document.getElementById('start-camera');
        const captureBtn = document.getElementById('capture-photo');
        const retakeBtn = document.getElementById('retake-photo');
        const useBtn = document.getElementById('use-photo');
        const closeBtn = document.getElementById('close-webcam');
        const video = document.getElementById('webcam-video');
        const canvas = document.getElementById('webcam-canvas');
        const placeholder = document.getElementById('webcam-placeholder');

        startBtn.addEventListener('click', async () => {
            try {
                // Vérifier si les médias sont supportés
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('La webcam n\'est pas supportée par ce navigateur');
                }
                
                // Demander l'accès à la webcam avec des contraintes spécifiques
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };
                
                webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = webcamStream;
                
                // Attendre que la vidéo soit prête
                video.onloadedmetadata = () => {
                    placeholder.style.display = 'none';
                    video.style.display = 'block';
                    startBtn.style.display = 'none';
                    captureBtn.style.display = 'inline-block';
                };
                
            } catch (err) {
                console.error('Erreur webcam:', err);
                let message = 'Erreur d\'accès à la webcam: ';
                
                if (err.name === 'NotAllowedError') {
                    message += 'Permission refusée. Veuillez autoriser l\'accès à la caméra dans les paramètres de votre navigateur.';
                } else if (err.name === 'NotFoundError') {
                    message += 'Aucune caméra trouvée sur cet appareil.';
                } else if (err.name === 'NotSupportedError') {
                    message += 'La webcam n\'est pas supportée par ce navigateur.';
                } else {
                    message += err.message;
                }
                
                alert(message);
            }
        });

        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'inline-block';
            useBtn.style.display = 'inline-block';
        });

        retakeBtn.addEventListener('click', () => {
            canvas.style.display = 'none';
            video.style.display = 'block';
            captureBtn.style.display = 'inline-block';
            retakeBtn.style.display = 'none';
            useBtn.style.display = 'none';
        });

        useBtn.addEventListener('click', () => {
            canvas.toBlob((blob) => {
                const file = new File([blob], 'webcam_capture.jpg', { type: 'image/jpeg' });
                this.setFileFromBlob(file);
                this.closeWebcamModal();
            }, 'image/jpeg', 0.8);
        });

        closeBtn.addEventListener('click', () => {
            this.closeWebcamModal();
        });
    }

    openWebcamModal() {
        document.getElementById('webcam-modal').classList.remove('hidden');
    }

    closeWebcamModal() {
        const modal = document.getElementById('webcam-modal');
        modal.classList.add('hidden');
        
        // Arrêter la webcam
        if (webcamStream) {
            webcamStream.getTracks().forEach(track => track.stop());
            webcamStream = null;
        }
        
        // Reset UI
        document.getElementById('webcam-video').style.display = 'none';
        document.getElementById('webcam-canvas').style.display = 'none';
        document.getElementById('webcam-placeholder').style.display = 'flex';
        document.getElementById('start-camera').style.display = 'inline-block';
        document.getElementById('capture-photo').style.display = 'none';
        document.getElementById('retake-photo').style.display = 'none';
        document.getElementById('use-photo').style.display = 'none';
    }

    // Crop Modal
    initializeCropModal() {
        const modal = document.getElementById('crop-modal');
        const applyBtn = document.getElementById('apply-crop');
        const cancelBtn = document.getElementById('cancel-crop');
        const closeBtn = document.getElementById('close-crop');

        applyBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.getCroppedCanvas().toBlob((blob) => {
                    const file = new File([blob], currentFile.name, { type: currentFile.type });
                    this.setFileFromBlob(file);
                    this.closeCropModal();
                }, currentFile.type);
            }
        });

        cancelBtn.addEventListener('click', () => {
            this.closeCropModal();
        });

        closeBtn.addEventListener('click', () => {
            this.closeCropModal();
        });
    }

    openCropModal() {
        if (!currentFile || !currentFile.type.startsWith('image/')) return;
        
        const modal = document.getElementById('crop-modal');
        const img = document.getElementById('crop-image');
        
        const reader = new FileReader();
        reader.onload = (e) => {
            img.src = e.target.result;
            img.style.display = 'block';
            
            // Initialiser Cropper
            cropper = new Cropper(img, {
                aspectRatio: NaN, // Libre
                viewMode: 2,
                dragMode: 'move',
                autoCropArea: 1,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
            });
        };
        reader.readAsDataURL(currentFile);
        
        modal.classList.remove('hidden');
    }

    closeCropModal() {
        const modal = document.getElementById('crop-modal');
        modal.classList.add('hidden');
        
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        document.getElementById('crop-image').style.display = 'none';
    }

    setFileFromBlob(file) {
        // Créer un DataTransfer pour simuler un fichier sélectionné
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById('fichier').files = dt.files;
        
        currentFile = file;
        this.showFilePreview(file);
        
        // Afficher le bouton de rognage pour les images
        const cropBtn = document.getElementById('crop-image-btn');
        if (file.type.startsWith('image/')) {
            cropBtn.classList.remove('hidden');
        }
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
}

// Fonctions existantes (maintenues pour compatibilité)
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleDateString('fr-FR') + ' à ' + now.toLocaleTimeString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    document.querySelector('.current-time').textContent = timeString;
}

function initializeRadioButtons() {
    const radioOptions = document.querySelectorAll('.mail-type-option');
    
    radioOptions.forEach(option => {
        const radio = option.querySelector('input[type="radio"]');
        const visual = option.querySelector('.radio-visual div');
        
        if (radio.checked) {
            visual.classList.remove('hidden');
            option.classList.add('border-rdc-blue', 'bg-blue-50');
        }
        
        option.addEventListener('click', function() {
            radioOptions.forEach(opt => {
                const vis = opt.querySelector('.radio-visual div');
                vis.classList.add('hidden');
                opt.classList.remove('border-rdc-blue', 'bg-blue-50');
            });
            
            radio.checked = true;
            visual.classList.remove('hidden');
            option.classList.add('border-rdc-blue', 'bg-blue-50');
            
            toggleContactField();
        });
    });
}

function toggleContactField() {
    const typeSelected = document.querySelector('input[name="type_courrier"]:checked').value;
    const contactLabel = document.getElementById('contact-label');
    const contactInput = document.getElementById('contact');
    const destinataireField = document.querySelector('input[name="destinataire"]');
    
    if (typeSelected === 'ENTRANT') {
        contactLabel.textContent = 'Expéditeur';
        contactInput.placeholder = 'Nom de l\'expéditeur';
        contactInput.name = 'expediteur';
        destinataireField.value = '';
    } else {
        contactLabel.textContent = 'Destinataire';
        contactInput.placeholder = 'Nom du destinataire';
        contactInput.name = 'destinataire';
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le gestionnaire de fichiers avancé
    new AdvancedFileHandler();
    
    // Initialiser les autres fonctions
    initializeRadioButtons();
    toggleContactField();
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
});
</script>
{% endblock %}
